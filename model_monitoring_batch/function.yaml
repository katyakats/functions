kind: job
metadata:
  name: model-monitoring-batch
  tag: ''
  hash: 5db19f721426ac50fc7e4c79e9700424ef36cfa4
  project: default
  categories:
  - monitoring
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: handler
  entry_points:
    compute:
      name: compute
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: capping
        default: null
      - name: kld_scaling
        default: 0.0001
      outputs:
      - default: ''
        type: float
      lineno: 64
    dict_to_histogram:
      name: dict_to_histogram
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: histogram_dict
        default: ''
      outputs:
      - default: ''
      lineno: 112
    compute_metrics_over_df:
      name: compute_metrics_over_df
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: base_histogram
        default: ''
      - name: latest_histogram
        default: ''
      outputs:
      - default: ''
      lineno: 129
    compute_drift_from_histograms:
      name: compute_drift_from_histograms
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: feature_stats
        default: ''
      - name: current_stats
        default: ''
      outputs:
      - default: ''
      lineno: 140
    post_init:
      name: post_init
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 305
    run:
      name: run
      doc: ''
      parameters:
      - name: self
        default: ''
      outputs:
      - default: ''
      lineno: 317
    check_for_drift:
      name: check_for_drift
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: drift_result
        default: ''
      - name: endpoint
        default: ''
      outputs:
      - default: ''
      lineno: 457
    get_last_created_dir:
      name: get_last_created_dir
      doc: ''
      parameters:
      - name: fs
        default: ''
      - name: endpoint_dir
        default: ''
      outputs:
      - default: ''
      lineno: 483
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      outputs:
      - default: ''
      lineno: 489
  description: ''
  build:
    functionSourceCode: aW1wb3J0IGpzb24KaW1wb3J0IG9zCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gZGF0YWNsYXNzZXMgaW1wb3J0IGRhdGFjbGFzcwpmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwsIExpc3QsIERpY3QKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCB2M2lvCmZyb20gbWxydW4gaW1wb3J0IGdldF9ydW5fZGIKZnJvbSBtbHJ1biBpbXBvcnQgc3RvcmVfbWFuYWdlcgpmcm9tIG1scnVuLmRhdGFfdHlwZXMuaW5mZXIgaW1wb3J0IERGRGF0YUluZmVyLCBJbmZlck9wdGlvbnMKZnJvbSBtbHJ1bi5ydW4gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4udXRpbHMgaW1wb3J0IGxvZ2dlciwgY29uZmlnCmZyb20gbWxydW4udXRpbHMubW9kZWxfbW9uaXRvcmluZyBpbXBvcnQgcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4CmZyb20gbWxydW4udXRpbHMudjNpb19jbGllbnRzIGltcG9ydCBnZXRfdjNpb19jbGllbnQsIGdldF9mcmFtZXNfY2xpZW50CmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBLQmluc0Rpc2NyZXRpemVyCgpUSU1FX0ZPUk1BVCA9ICIlWS0lbS0lZCAlSDolTTolUy4lZiV6IgoKCkBkYXRhY2xhc3MKY2xhc3MgVG90YWxWYXJpYW5jZURpc3RhbmNlOgogICAgIiIiCiAgICBQcm92aWRlcyBhIHN5bW1ldHJpYyBkcmlmdCBkaXN0YW5jZSBiZXR3ZWVuIHR3byBwZXJpb2RzIHQgYW5kIHUKICAgIFogLSB2ZWN0b3Igb2YgcmFuZG9tIHZhcmlhYmxlcwogICAgUHQgLSBQcm9iYWJpbGl0eSBkaXN0cmlidXRpb24gb3ZlciB0aW1lIHNwYW4gdAogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmKSAtPiBmbG9hdDoKICAgICAgICByZXR1cm4gbnAuc3VtKG5wLmFicyhzZWxmLmRpc3RyaWJfdCAtIHNlbGYuZGlzdHJpYl91KSkgLyAyCgoKQGRhdGFjbGFzcwpjbGFzcyBIZWxsaW5nZXJEaXN0YW5jZToKICAgICIiIgogICAgSGVsbGluZ2VyIGRpc3RhbmNlIGlzIGFuIGYgZGl2ZXJnZW5jZSBtZWFzdXJlLCBzaW1pbGFyIHRvIHRoZSBLdWxsYmFjay1MZWlibGVyIChLTCkgZGl2ZXJnZW5jZS4KICAgIEhvd2V2ZXIsIHVubGlrZSBLTCBEaXZlcmdlbmNlIHRoZSBIZWxsaW5nZXIgZGl2ZXJnZW5jZSBpcyBzeW1tZXRyaWMgYW5kIGJvdW5kZWQgb3ZlciBhIHByb2JhYmlsaXR5IHNwYWNlLgogICAgIiIiCgogICAgZGlzdHJpYl90OiBucC5uZGFycmF5CiAgICBkaXN0cmliX3U6IG5wLm5kYXJyYXkKCiAgICBkZWYgY29tcHV0ZShzZWxmKSAtPiBmbG9hdDoKICAgICAgICByZXR1cm4gbnAuc3FydCgKICAgICAgICAgICAgMC41ICogKChucC5zcXJ0KHNlbGYuZGlzdHJpYl91KSAtIG5wLnNxcnQoc2VsZi5kaXN0cmliX3QpKSAqKiAyKS5zdW0oKQogICAgICAgICkKCgpAZGF0YWNsYXNzCmNsYXNzIEt1bGxiYWNrTGVpYmxlckRpdmVyZ2VuY2U6CiAgICAiIiIKICAgIEtMIERpdmVyZ2VuY2UgKG9yIHJlbGF0aXZlIGVudHJvcHkpIGlzIGEgbWVhc3VyZSBvZiBob3cgb25lIHByb2JhYmlsaXR5IGRpc3RyaWJ1dGlvbiBkaWZmZXJzIGZyb20gYW5vdGhlci4KICAgIEl0IGlzIGFuIGFzeW1tZXRyaWMgbWVhc3VyZSAodGh1cyBpdCdzIG5vdCBhIG1ldHJpYykgYW5kIGl0IGRvZXNuJ3Qgc2F0aXNmeSB0aGUgdHJpYW5nbGUgaW5lcXVhbGl0eS4KICAgIEtMIERpdmVyZ2VuY2Ugb2YgMCwgaW5kaWNhdGVzIHR3byBpZGVudGljYWwgZGlzdHJpYnV0aW9ucy4KICAgICIiIgoKICAgIGRpc3RyaWJfdDogbnAubmRhcnJheQogICAgZGlzdHJpYl91OiBucC5uZGFycmF5CgogICAgZGVmIGNvbXB1dGUoc2VsZiwgY2FwcGluZz1Ob25lLCBrbGRfc2NhbGluZz0wLjAwMDEpIC0+IGZsb2F0OgogICAgICAgIHRfdSA9IG5wLnN1bSgKICAgICAgICAgICAgbnAud2hlcmUoCiAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdCAhPSAwLAogICAgICAgICAgICAgICAgKHNlbGYuZGlzdHJpYl90KQogICAgICAgICAgICAgICAgKiBucC5sb2coCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3QKICAgICAgICAgICAgICAgICAgICAvIG5wLndoZXJlKHNlbGYuZGlzdHJpYl91ICE9IDAsIHNlbGYuZGlzdHJpYl91LCBrbGRfc2NhbGluZykKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHVfdCA9IG5wLnN1bSgKICAgICAgICAgICAgbnAud2hlcmUoCiAgICAgICAgICAgICAgICBzZWxmLmRpc3RyaWJfdSAhPSAwLAogICAgICAgICAgICAgICAgKHNlbGYuZGlzdHJpYl91KQogICAgICAgICAgICAgICAgKiBucC5sb2coCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXN0cmliX3UKICAgICAgICAgICAgICAgICAgICAvIG5wLndoZXJlKHNlbGYuZGlzdHJpYl90ICE9IDAsIHNlbGYuZGlzdHJpYl90LCBrbGRfc2NhbGluZykKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHJlc3VsdCA9IHRfdSArIHVfdAogICAgICAgIGlmIGNhcHBpbmc6CiAgICAgICAgICAgIHJldHVybiBjYXBwaW5nIGlmIHJlc3VsdCA9PSBmbG9hdCgiaW5mIikgZWxzZSByZXN1bHQKICAgICAgICByZXR1cm4gcmVzdWx0CgoKY2xhc3MgVmlydHVhbERyaWZ0OgogICAgZGVmIF9faW5pdF9fKAogICAgICAgIHNlbGYsCiAgICAgICAgcHJlZGljdGlvbl9jb2w6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgIGxhYmVsX2NvbDogT3B0aW9uYWxbc3RyXSA9IE5vbmUsCiAgICAgICAgZmVhdHVyZV93ZWlnaHRzOiBPcHRpb25hbFtMaXN0W2Zsb2F0XV0gPSBOb25lLAogICAgICAgIGluZl9jYXBwaW5nOiBPcHRpb25hbFtmbG9hdF0gPSAxMCwKICAgICk6CiAgICAgICAgc2VsZi5wcmVkaWN0aW9uX2NvbCA9IHByZWRpY3Rpb25fY29sCiAgICAgICAgc2VsZi5sYWJlbF9jb2wgPSBsYWJlbF9jb2wKICAgICAgICBzZWxmLmZlYXR1cmVfd2VpZ2h0cyA9IGZlYXR1cmVfd2VpZ2h0cwogICAgICAgIHNlbGYuY2FwcGluZyA9IGluZl9jYXBwaW5nCiAgICAgICAgc2VsZi5kaXNjcmV0aXplcnM6IERpY3Rbc3RyLCBLQmluc0Rpc2NyZXRpemVyXSA9IHt9CiAgICAgICAgc2VsZi5tZXRyaWNzID0gewogICAgICAgICAgICAidHZkIjogVG90YWxWYXJpYW5jZURpc3RhbmNlLAogICAgICAgICAgICAiaGVsbGluZ2VyIjogSGVsbGluZ2VyRGlzdGFuY2UsCiAgICAgICAgICAgICJrbGQiOiBLdWxsYmFja0xlaWJsZXJEaXZlcmdlbmNlLAogICAgICAgIH0KCiAgICBkZWYgZGljdF90b19oaXN0b2dyYW0oc2VsZiwgaGlzdG9ncmFtX2RpY3QpOgogICAgICAgIGhpc3RvZ3JhbXMgPSB7fQogICAgICAgIGZvciBmZWF0dXJlLCBzdGF0cyBpbiBoaXN0b2dyYW1fZGljdC5pdGVtcygpOgogICAgICAgICAgICBoaXN0b2dyYW1zW2ZlYXR1cmVdID0gc3RhdHNbImhpc3QiXVswXQoKICAgICAgICAjIEdldCBmZWF0dXJlcyB2YWx1ZSBjb3VudHMKICAgICAgICBoaXN0b2dyYW1zID0gcGQuY29uY2F0KAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBwZC5EYXRhRnJhbWUoZGF0YT1oaXN0LCBjb2x1bW5zPVtmZWF0dXJlXSkKICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlLCBoaXN0IGluIGhpc3RvZ3JhbXMuaXRlbXMoKQogICAgICAgICAgICBdLAogICAgICAgICAgICBheGlzPTEsCiAgICAgICAgKQogICAgICAgICMgVG8gRGlzdHJpYnV0aW9uCiAgICAgICAgaGlzdG9ncmFtcyA9IGhpc3RvZ3JhbXMgLyBoaXN0b2dyYW1zLnN1bSgpCiAgICAgICAgcmV0dXJuIGhpc3RvZ3JhbXMKCiAgICBkZWYgY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoc2VsZiwgYmFzZV9oaXN0b2dyYW0sIGxhdGVzdF9oaXN0b2dyYW0pOgogICAgICAgIGRyaWZ0X21lYXN1cmVzID0ge30KICAgICAgICBmb3IgbWV0cmljX25hbWUsIG1ldHJpYyBpbiBzZWxmLm1ldHJpY3MuaXRlbXMoKToKICAgICAgICAgICAgZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdID0gewogICAgICAgICAgICAgICAgZmVhdHVyZTogbWV0cmljKAogICAgICAgICAgICAgICAgICAgIGJhc2VfaGlzdG9ncmFtLmxvY1s6LCBmZWF0dXJlXSwgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgZmVhdHVyZV0KICAgICAgICAgICAgICAgICkuY29tcHV0ZSgpCiAgICAgICAgICAgICAgICBmb3IgZmVhdHVyZSBpbiBiYXNlX2hpc3RvZ3JhbQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRyaWZ0X21lYXN1cmVzCgogICAgZGVmIGNvbXB1dGVfZHJpZnRfZnJvbV9oaXN0b2dyYW1zKHNlbGYsIGZlYXR1cmVfc3RhdHMsIGN1cnJlbnRfc3RhdHMpOgogICAgICAgIHByaW50KGYiaW5zaWRlIHRoZSBmdW5jMSBmZWF0dXJlX3N0YXRzIGlzIHtmZWF0dXJlX3N0YXRzfSwgY3VycmVudF9zdGF0cyBpcyB7Y3VycmVudF9zdGF0c30iKQoKICAgICAgICAjIFByb2Nlc3MgaGlzdG9ncmFtIGRpY3Rpb25hcmllcyB0byBEYXRhZnJhbWUgb2YgdGhlIGhpc3RvZ3JhbXMKICAgICAgICAjIHdpdGggRmVhdHVyZSBoaXN0b2dyYW0gYXMgY29scwogICAgICAgIGJhc2VfaGlzdG9ncmFtID0gc2VsZi5kaWN0X3RvX2hpc3RvZ3JhbShmZWF0dXJlX3N0YXRzKQogICAgICAgIHByaW50KGYiYmFzZV9oaXN0b2dyYW0gaXMge2Jhc2VfaGlzdG9ncmFtfSIpCgogICAgICAgIGxhdGVzdF9oaXN0b2dyYW0gPSBzZWxmLmRpY3RfdG9faGlzdG9ncmFtKGN1cnJlbnRfc3RhdHMpCiAgICAgICAgcHJpbnQoZiJsYXRlc3RfaGlzdG9ncmFtIGlzIHtsYXRlc3RfaGlzdG9ncmFtfSIpCgogICAgICAgICMgVmVyaWZ5IGFsbCB0aGUgZmVhdHVyZXMgZXhpc3QgYmV0d2VlbiBkYXRhc2V0cwogICAgICAgIGJhc2VfZmVhdHVyZXMgPSBzZXQoYmFzZV9oaXN0b2dyYW0uY29sdW1ucykKICAgICAgICBwcmludChmImJhc2VfZmVhdHVyZXMgaXMge2Jhc2VfZmVhdHVyZXN9IikKCiAgICAgICAgbGF0ZXN0X2ZlYXR1cmVzID0gc2V0KGxhdGVzdF9oaXN0b2dyYW0uY29sdW1ucykKICAgICAgICBwcmludChmImxhdGVzdF9mZWF0dXJlcyBpcyB7bGF0ZXN0X2ZlYXR1cmVzfSIpCgogICAgICAgIGZlYXR1cmVzX2NvbW1vbiA9IGxpc3QoYmFzZV9mZWF0dXJlcy5pbnRlcnNlY3Rpb24obGF0ZXN0X2ZlYXR1cmVzKSkKICAgICAgICBwcmludChmImZlYXR1cmVzX2NvbW1vbiBpcyB7ZmVhdHVyZXNfY29tbW9ufSIpCgogICAgICAgIGZlYXR1cmVfZGlmZmVyZW5jZSA9IGxpc3QoYmFzZV9mZWF0dXJlcyBeIGxhdGVzdF9mZWF0dXJlcykKCiAgICAgICAgcHJpbnQoZiJmZWF0dXJlX2RpZmZlcmVuY2UgaXMge2ZlYXR1cmVfZGlmZmVyZW5jZX0iKQoKICAgICAgICBpZiBub3QgZmVhdHVyZXNfY29tbW9uOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgZiJObyBjb21tb24gZmVhdHVyZXMgZm91bmQ6IHtiYXNlX2ZlYXR1cmVzfSA8PiB7bGF0ZXN0X2ZlYXR1cmVzfSIKICAgICAgICAgICAgKQoKICAgICAgICBiYXNlX2hpc3RvZ3JhbSA9IGJhc2VfaGlzdG9ncmFtLmRyb3AoCiAgICAgICAgICAgIGZlYXR1cmVfZGlmZmVyZW5jZSwgYXhpcz0xLCBlcnJvcnM9Imlnbm9yZSIKICAgICAgICApCiAgICAgICAgcHJpbnQoZiJiYXNlX2hpc3RvZ3JhbSBpcyB7YmFzZV9oaXN0b2dyYW19IikKCiAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbSA9IGxhdGVzdF9oaXN0b2dyYW0uZHJvcCgKICAgICAgICAgICAgZmVhdHVyZV9kaWZmZXJlbmNlLCBheGlzPTEsIGVycm9ycz0iaWdub3JlIgogICAgICAgICkKICAgICAgICBwcmludChmImxhdGVzdF9oaXN0b2dyYW0gaXMge2xhdGVzdF9oaXN0b2dyYW19IikKCiAgICAgICAgIyBDb21wdXRlIHRoZSBkcmlmdCBwZXIgZmVhdHVyZQogICAgICAgIGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzID0gc2VsZi5jb21wdXRlX21ldHJpY3Nfb3Zlcl9kZigKICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVzX2NvbW1vbl0sCiAgICAgICAgICAgIGxhdGVzdF9oaXN0b2dyYW0ubG9jWzosIGZlYXR1cmVzX2NvbW1vbl0sCiAgICAgICAgKQogICAgICAgIHByaW50KGYiZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXMgaXMge2ZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzfSIpCgogICAgICAgICMgQ29tcHV0ZSB0b3RhbCBkcmlmdCBtZWFzdXJlcyBmb3IgZmVhdHVyZXMKICAgICAgICBmb3IgbWV0cmljX25hbWUgaW4gc2VsZi5tZXRyaWNzLmtleXMoKToKICAgICAgICAgICAgZmVhdHVyZV92YWx1ZXMgPSBsaXN0KGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY19uYW1lXS52YWx1ZXMoKSkKICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF9zdW0iXSA9IG5wLnN1bShmZWF0dXJlX3ZhbHVlcykKICAgICAgICAgICAgZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljX25hbWVdWyJ0b3RhbF9tZWFuIl0gPSBucC5tZWFuKGZlYXR1cmVfdmFsdWVzKQoKICAgICAgICAgICAgIyBBZGQgd2VpZ2h0ZWQgbWVhbiBieSBnaXZlbiBmZWF0dXJlIHdlaWdodHMgaWYgcHJvdmlkZWQKICAgICAgICAgICAgaWYgc2VsZi5mZWF0dXJlX3dlaWdodHM6CiAgICAgICAgICAgICAgICBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNfbmFtZV1bInRvdGFsX3dlaWdodGVkX21lYW4iXSA9IG5wLmRvdCgKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX3ZhbHVlcywgc2VsZi5mZWF0dXJlX3dlaWdodHMKICAgICAgICAgICAgICAgICkKCiAgICAgICAgZHJpZnRfcmVzdWx0ID0gZGVmYXVsdGRpY3QoZGljdCkKCiAgICAgICAgcHJpbnQoZiJmZWF0dXJlc19jb21tb24gaXMge2ZlYXR1cmVzX2NvbW1vbn0iKQoKICAgICAgICBmb3IgZmVhdHVyZSBpbiBmZWF0dXJlc19jb21tb246CiAgICAgICAgICAgIHByaW50KGYiZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXMgaXMge2ZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzfSIpCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBmZWF0dXJlc19kcmlmdF9tZWFzdXJlcy5pdGVtcygpOgogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2ZlYXR1cmVdW21ldHJpY10gPSB2YWx1ZXNbZmVhdHVyZV0KICAgICAgICAgICAgICAgIHN1bSA9IGZlYXR1cmVzX2RyaWZ0X21lYXN1cmVzW21ldHJpY11bInRvdGFsX3N1bSJdCiAgICAgICAgICAgICAgICBtZWFuID0gZmVhdHVyZXNfZHJpZnRfbWVhc3VyZXNbbWV0cmljXVsidG90YWxfbWVhbiJdCiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV9zdW0iXSA9IHN1bQogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W2Yie21ldHJpY31fbWVhbiJdID0gbWVhbgogICAgICAgICAgICAgICAgaWYgc2VsZi5mZWF0dXJlX3dlaWdodHM6CiAgICAgICAgICAgICAgICAgICAgbWV0cmljX21lYXN1cmUgPSBmZWF0dXJlc19kcmlmdF9tZWFzdXJlc1ttZXRyaWNdCiAgICAgICAgICAgICAgICAgICAgd2VpZ2h0ZWRfbWVhbiA9IG1ldHJpY19tZWFzdXJlWyJ0b3RhbF93ZWlnaHRlZF9tZWFuIl0KICAgICAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbZiJ7bWV0cmljfV93ZWlnaHRlZF9tZWFuIl0gPSB3ZWlnaHRlZF9tZWFuCgogICAgICAgIGlmIHNlbGYubGFiZWxfY29sOgogICAgICAgICAgICBwcmludChmInNlbGYubGFiZWxfY29sIGlzIHtzZWxmLmxhYmVsX2NvbH0iKQogICAgICAgICAgICBsYWJlbF9kcmlmdF9tZWFzdXJlcyA9IHNlbGYuY29tcHV0ZV9tZXRyaWNzX292ZXJfZGYoCiAgICAgICAgICAgICAgICBiYXNlX2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5sYWJlbF9jb2xdLAogICAgICAgICAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5sYWJlbF9jb2xdLAogICAgICAgICAgICApCiAgICAgICAgICAgIHByaW50KGYibGFiZWxfZHJpZnRfbWVhc3VyZXMgaXMge2xhYmVsX2RyaWZ0X21lYXN1cmVzfSIpCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBsYWJlbF9kcmlmdF9tZWFzdXJlcy5pdGVtcygpOgogICAgICAgICAgICAgICAgZHJpZnRfcmVzdWx0W3NlbGYubGFiZWxfY29sXVttZXRyaWNdID0gdmFsdWVzW21ldHJpY10KCiAgICAgICAgaWYgc2VsZi5wcmVkaWN0aW9uX2NvbDoKICAgICAgICAgICAgcHJpbnQoZiJzZWxmLnByZWRpY3Rpb25fY29sIGlzIHtzZWxmLnByZWRpY3Rpb25fY29sfSIpCiAgICAgICAgICAgIHByZWRpY3Rpb25fZHJpZnRfbWVhc3VyZXMgPSBzZWxmLmNvbXB1dGVfbWV0cmljc19vdmVyX2RmKAogICAgICAgICAgICAgICAgYmFzZV9oaXN0b2dyYW0ubG9jWzosIHNlbGYucHJlZGljdGlvbl9jb2xdLAogICAgICAgICAgICAgICAgbGF0ZXN0X2hpc3RvZ3JhbS5sb2NbOiwgc2VsZi5wcmVkaWN0aW9uX2NvbF0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgcHJpbnQoZiJwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzIGlzIHtwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzfSIpCiAgICAgICAgICAgIGZvciBtZXRyaWMsIHZhbHVlcyBpbiBwcmVkaWN0aW9uX2RyaWZ0X21lYXN1cmVzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHRbc2VsZi5wcmVkaWN0aW9uX2NvbF1bbWV0cmljXSA9IHZhbHVlc1ttZXRyaWNdCgogICAgICAgIHJldHVybiBkcmlmdF9yZXN1bHQKCgpjbGFzcyBCYXRjaFByb2Nlc3NvcjoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgICAgIHByb2plY3Q6IHN0ciwKICAgICAgICBtb2RlbF9tb25pdG9yaW5nX2FjY2Vzc19rZXk6IHN0ciwKICAgICAgICB2M2lvX2FjY2Vzc19rZXk6IHN0ciwKICAgICk6CiAgICAgICAgc2VsZi5jb250ZXh0ID0gY29udGV4dAogICAgICAgIHNlbGYucHJvamVjdCA9IHByb2plY3QKCiAgICAgICAgc2VsZi52M2lvX2FjY2Vzc19rZXkgPSB2M2lvX2FjY2Vzc19rZXkKICAgICAgICBzZWxmLm1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleSA9ICgKICAgICAgICAgICAgbW9kZWxfbW9uaXRvcmluZ19hY2Nlc3Nfa2V5IG9yIHYzaW9fYWNjZXNzX2tleQogICAgICAgICkKCiAgICAgICAgc2VsZi52aXJ0dWFsX2RyaWZ0ID0gVmlydHVhbERyaWZ0KGluZl9jYXBwaW5nPTEwKQoKICAgICAgICB0ZW1wbGF0ZSA9IGNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLnN0b3JlX3ByZWZpeGVzLmRlZmF1bHQKCiAgICAgICAga3ZfcGF0aCA9IHRlbXBsYXRlLmZvcm1hdChwcm9qZWN0PXNlbGYucHJvamVjdCwga2luZD0iZW5kcG9pbnRzIikKICAgICAgICBfLCBzZWxmLmt2X2NvbnRhaW5lciwgc2VsZi5rdl9wYXRoID0gcGFyc2VfbW9kZWxfZW5kcG9pbnRfc3RvcmVfcHJlZml4KGt2X3BhdGgpCgogICAgICAgIHRzZGJfcGF0aCA9IHRlbXBsYXRlLmZvcm1hdChwcm9qZWN0PXByb2plY3QsIGtpbmQ9ImV2ZW50cyIpCiAgICAgICAgXywgc2VsZi50c2RiX2NvbnRhaW5lciwgc2VsZi50c2RiX3BhdGggPSBwYXJzZV9tb2RlbF9lbmRwb2ludF9zdG9yZV9wcmVmaXgoCiAgICAgICAgICAgIHRzZGJfcGF0aAogICAgICAgICkKCiAgICAgICAgc3RyZWFtX3BhdGggPSB0ZW1wbGF0ZS5mb3JtYXQocHJvamVjdD1zZWxmLnByb2plY3QsIGtpbmQ9ImxvZ19zdHJlYW0iKQogICAgICAgIF8sIHNlbGYuc3RyZWFtX2NvbnRhaW5lciwgc2VsZi5zdHJlYW1fcGF0aCA9IHBhcnNlX21vZGVsX2VuZHBvaW50X3N0b3JlX3ByZWZpeCgKICAgICAgICAgICAgc3RyZWFtX3BhdGgKICAgICAgICApCgogICAgICAgIHNlbGYucGFycXVldF9wYXRoID0gY29uZmlnLm1vZGVsX2VuZHBvaW50X21vbml0b3Jpbmcuc3RvcmVfcHJlZml4ZXMudXNlcl9zcGFjZS5mb3JtYXQoCiAgICAgICAgICAgIHByb2plY3Q9cHJvamVjdCwga2luZD0icGFycXVldCIKICAgICAgICApCgogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAiSW5pdGlhbGl6aW5nIEJhdGNoUHJvY2Vzc29yIiwKICAgICAgICAgICAgcHJvamVjdD1wcm9qZWN0LAogICAgICAgICAgICBtb2RlbF9tb25pdG9yaW5nX2FjY2Vzc19rZXlfaW5pdGFsaXplZD1ib29sKG1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleSksCiAgICAgICAgICAgIHYzaW9fYWNjZXNzX2tleV9pbml0aWFsaXplZD1ib29sKHYzaW9fYWNjZXNzX2tleSksCiAgICAgICAgICAgIHBhcnF1ZXRfcGF0aD1zZWxmLnBhcnF1ZXRfcGF0aCwKICAgICAgICAgICAga3ZfY29udGFpbmVyPXNlbGYua3ZfY29udGFpbmVyLAogICAgICAgICAgICBrdl9wYXRoPXNlbGYua3ZfcGF0aCwKICAgICAgICAgICAgdHNkYl9jb250YWluZXI9c2VsZi50c2RiX2NvbnRhaW5lciwKICAgICAgICAgICAgdHNkYl9wYXRoPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICBzdHJlYW1fY29udGFpbmVyPXNlbGYuc3RyZWFtX2NvbnRhaW5lciwKICAgICAgICAgICAgc3RyZWFtX3BhdGg9c2VsZi5zdHJlYW1fcGF0aCwKICAgICAgICApCgogICAgICAgIHNlbGYuZGVmYXVsdF9wb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQgPSAoCiAgICAgICAgICAgIGNvbmZpZy5tb2RlbF9lbmRwb2ludF9tb25pdG9yaW5nLmRyaWZ0X3RocmVzaG9sZHMuZGVmYXVsdC5wb3NzaWJsZV9kcmlmdAogICAgICAgICkKICAgICAgICBzZWxmLmRlZmF1bHRfZHJpZnRfZGV0ZWN0ZWRfdGhyZXNob2xkID0gKAogICAgICAgICAgICBjb25maWcubW9kZWxfZW5kcG9pbnRfbW9uaXRvcmluZy5kcmlmdF90aHJlc2hvbGRzLmRlZmF1bHQuZHJpZnRfZGV0ZWN0ZWQKICAgICAgICApCgogICAgICAgIHNlbGYuZGIgPSBnZXRfcnVuX2RiKCkKICAgICAgICBzZWxmLnYzaW8gPSBnZXRfdjNpb19jbGllbnQoYWNjZXNzX2tleT1zZWxmLnYzaW9fYWNjZXNzX2tleSkKICAgICAgICBzZWxmLmZyYW1lcyA9IGdldF9mcmFtZXNfY2xpZW50KAogICAgICAgICAgICBhZGRyZXNzPWNvbmZpZy52M2lvX2ZyYW1lc2QsCiAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLnRzZGJfY29udGFpbmVyLAogICAgICAgICAgICB0b2tlbj1zZWxmLnYzaW9fYWNjZXNzX2tleSwKICAgICAgICApCgogICAgZGVmIHBvc3RfaW5pdChzZWxmKToKICAgICAgICByZXNwb25zZSA9IHNlbGYudjNpby5jcmVhdGVfc3RyZWFtKAogICAgICAgICAgICBjb250YWluZXI9c2VsZi5zdHJlYW1fY29udGFpbmVyLAogICAgICAgICAgICBwYXRoPXNlbGYuc3RyZWFtX3BhdGgsCiAgICAgICAgICAgIHNoYXJkX2NvdW50PTEsCiAgICAgICAgICAgIHJhaXNlX2Zvcl9zdGF0dXM9djNpby5kYXRhcGxhbmUuUmFpc2VGb3JTdGF0dXMubmV2ZXIsCiAgICAgICAgICAgIGFjY2Vzc19rZXk9c2VsZi52M2lvX2FjY2Vzc19rZXksCiAgICAgICAgKQoKICAgICAgICBpZiBub3QgKHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDQwMCBhbmQgIlJlc291cmNlSW5Vc2UiIGluIHN0cihyZXNwb25zZS5ib2R5KSk6CiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoWzQwOSwgMjA0LCA0MDNdKQoKICAgIGRlZiBydW4oc2VsZik6CgogICAgICAgIHRyeToKICAgICAgICAgICAgZW5kcG9pbnRzID0gc2VsZi5kYi5saXN0X21vZGVsX2VuZHBvaW50cyhzZWxmLnByb2plY3QpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBsaXN0IGVuZHBvaW50cyIsIGV4Yz1lKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYWN0aXZlX2VuZHBvaW50cyA9IHNldCgpCiAgICAgICAgZm9yIGVuZHBvaW50IGluIGVuZHBvaW50cy5lbmRwb2ludHM6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTk5OTiBhY3RpdmUgZm9yIGVuZHBvaW50e2VuZHBvaW50Lm1ldGFkYXRhLnVpZH0gYWN0aXZlIHtlbmRwb2ludC5zcGVjLmFjdGl2ZX0iKQogICAgICAgICAgICBpZiBlbmRwb2ludC5zcGVjLmFjdGl2ZToKICAgICAgICAgICAgICAgIGFjdGl2ZV9lbmRwb2ludHMuYWRkKGVuZHBvaW50Lm1ldGFkYXRhLnVpZCkKCiAgICAgICAgc3RvcmUsIHN1YiA9IHN0b3JlX21hbmFnZXIuZ2V0X29yX2NyZWF0ZV9zdG9yZShzZWxmLnBhcnF1ZXRfcGF0aCkKICAgICAgICBwcmVmaXggPSBzZWxmLnBhcnF1ZXRfcGF0aC5yZXBsYWNlKHN1YiwgIiIpCiAgICAgICAgZnMgPSBzdG9yZS5nZXRfZmlsZXN5c3RlbShzaWxlbnQ9RmFsc2UpCgogICAgICAgIGlmIG5vdCBmcy5leGlzdHMoc3ViKToKICAgICAgICAgICAgbG9nZ2VyLndhcm4oCiAgICAgICAgICAgICAgICBmIntzdWJ9IGRvZXMgbm90IGV4aXN0IgogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBmb3IgZW5kcG9pbnRfZGlyIGluIGZzLmxzKHN1Yik6CiAgICAgICAgICAgIGVuZHBvaW50X2lkID0gZW5kcG9pbnRfZGlyWyJuYW1lIl0uc3BsaXQoIj0iKVstMV0KICAgICAgICAgICAgaWYgZW5kcG9pbnRfaWQgbm90IGluIGFjdGl2ZV9lbmRwb2ludHM6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF95ZWFyID0gc2VsZi5nZXRfbGFzdF9jcmVhdGVkX2RpcihmcywgZW5kcG9pbnRfZGlyKQogICAgICAgICAgICAgICAgbGFzdF9tb250aCA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZnMsIGxhc3RfeWVhcikKICAgICAgICAgICAgICAgIGxhc3RfZGF5ID0gc2VsZi5nZXRfbGFzdF9jcmVhdGVkX2RpcihmcywgbGFzdF9tb250aCkKICAgICAgICAgICAgICAgIGxhc3RfaG91ciA9IHNlbGYuZ2V0X2xhc3RfY3JlYXRlZF9kaXIoZnMsIGxhc3RfZGF5KQoKICAgICAgICAgICAgICAgIGZ1bGxfcGF0aCA9IGYie3ByZWZpeH17bGFzdF9ob3VyWyduYW1lJ119IgoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTm93IHByb2Nlc3Npbmcge2Z1bGxfcGF0aH0iKQoKICAgICAgICAgICAgICAgIGVuZHBvaW50ID0gc2VsZi5kYi5nZXRfbW9kZWxfZW5kcG9pbnQoCiAgICAgICAgICAgICAgICAgICAgcHJvamVjdD1zZWxmLnByb2plY3QsIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBmcm9tIG1scnVuLnV0aWxzLm1vZGVsX21vbml0b3JpbmcgaW1wb3J0IEVuZHBvaW50VHlwZQoKICAgICAgICAgICAgICAgIHByaW50KGYiY2hlY2tpbmcgZm9yIHR5cGUiKQogICAgICAgICAgICAgICAgaWYgZW5kcG9pbnQuc3RhdHVzLmVuZHBvaW50X3R5cGUgPT0gRW5kcG9pbnRUeXBlLlJPVVRFUjoKICAgICAgICAgICAgICAgICAgICBwcmludChmInRoaXMgaXMgcm91dGVyIHNraXBwaW5nLiBmZWF0dXJlIHN0YXR1cyBpcyB7ZW5kcG9pbnQuc3RhdHVzLmZlYXR1cmVfc3RhdHN9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIHByaW50KGYiTk5OTk5OIGVuZHBvaW50IGlzIHtlbmRwb2ludH0iKQogICAgICAgICAgICAgICAgcHJpbnQoZiJOTk5OTk5OIE1BWUJFIE5PVzIgZmVhdHVyZV9zdGF0cyBpcyB7ZW5kcG9pbnQuc3RhdHVzLmZlYXR1cmVfc3RhdHN9IikKCiAgICAgICAgICAgICAgICBkZiA9IHBkLnJlYWRfcGFycXVldChmdWxsX3BhdGgpCgogICAgICAgICAgICAgICAgcHJpbnQoZiJkYXRhZnJhbWUgaXMge2RmfSIpCiAgICAgICAgICAgICAgICB0aW1lc3RhbXAgPSBkZlsidGltZXN0YW1wIl0uaWxvY1stMV0KCiAgICAgICAgICAgICAgICBwcmludChmInRpbWVzdGFtcCBpcyB7dGltZXN0YW1wfSIpCiAgICAgICAgICAgICAgICBuYW1lZF9mZWF0dXJlc19kZiA9IGxpc3QoZGZbIm5hbWVkX2ZlYXR1cmVzIl0pCiAgICAgICAgICAgICAgICBwcmludChmIm5hbWVkX2ZlYXR1cmVzX2RmIGlzIHtuYW1lZF9mZWF0dXJlc19kZn0iKQoKICAgICAgICAgICAgICAgIG5hbWVkX2ZlYXR1cmVzX2RmID0gcGQuRGF0YUZyYW1lKG5hbWVkX2ZlYXR1cmVzX2RmKQoKICAgICAgICAgICAgICAgIHByaW50KGYibmFtZWRfZmVhdHVyZXNfZGYyIGlzIHtuYW1lZF9mZWF0dXJlc19kZn0iKQoKICAgICAgICAgICAgICAgIGN1cnJlbnRfc3RhdHMgPSBERkRhdGFJbmZlci5nZXRfc3RhdHMoCiAgICAgICAgICAgICAgICAgICAgZGY9bmFtZWRfZmVhdHVyZXNfZGYsIG9wdGlvbnM9SW5mZXJPcHRpb25zLkhpc3RvZ3JhbQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIHByaW50KGYiY3VycmVudF9zdGF0cyBpcyB7Y3VycmVudF9zdGF0c30iKQogICAgICAgICAgICAgICAgcHJpbnQoZiJmZWF0dXJlX3N0YXRzIGlzIHtlbmRwb2ludC5zdGF0dXMuZmVhdHVyZV9zdGF0c30iKQoKICAgICAgICAgICAgICAgIGRyaWZ0X3Jlc3VsdCA9IHNlbGYudmlydHVhbF9kcmlmdC5jb21wdXRlX2RyaWZ0X2Zyb21faGlzdG9ncmFtcygKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX3N0YXRzPWVuZHBvaW50LnN0YXR1cy5mZWF0dXJlX3N0YXRzLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfc3RhdHM9Y3VycmVudF9zdGF0cywKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiRHJpZnQgcmVzdWx0IiwgZHJpZnRfcmVzdWx0PWRyaWZ0X3Jlc3VsdCkKCiAgICAgICAgICAgICAgICBkcmlmdF9zdGF0dXMsIGRyaWZ0X21lYXN1cmUgPSBzZWxmLmNoZWNrX2Zvcl9kcmlmdCgKICAgICAgICAgICAgICAgICAgICBkcmlmdF9yZXN1bHQ9ZHJpZnRfcmVzdWx0LCBlbmRwb2ludD1lbmRwb2ludAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICAgICAgICAgICJEcmlmdCBzdGF0dXMiLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X2lkPWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIGRyaWZ0X3N0YXR1cz1kcmlmdF9zdGF0dXMsCiAgICAgICAgICAgICAgICAgICAgZHJpZnRfbWVhc3VyZT1kcmlmdF9tZWFzdXJlLAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGlmIGRyaWZ0X3N0YXR1cyA9PSAiUE9TU0lCTEVfRFJJRlQiIG9yIGRyaWZ0X3N0YXR1cyA9PSAiRFJJRlRfREVURUNURUQiOgogICAgICAgICAgICAgICAgICAgIHNlbGYudjNpby5zdHJlYW0ucHV0X3JlY29yZHMoCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcj1zZWxmLnN0cmVhbV9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV9wYXRoPXNlbGYuc3RyZWFtX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZHM9WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkYXRhIjoganNvbi5kdW1wcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImVuZHBvaW50X2lkIjogZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZHJpZnRfc3RhdHVzIjogZHJpZnRfc3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X21lYXN1cmUiOiBkcmlmdF9tZWFzdXJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X3Blcl9mZWF0dXJlIjogeyoqZHJpZnRfcmVzdWx0fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgc2VsZi52M2lvLmt2LnVwZGF0ZSgKICAgICAgICAgICAgICAgICAgICBjb250YWluZXI9c2VsZi5rdl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGFibGVfcGF0aD1zZWxmLmt2X3BhdGgsCiAgICAgICAgICAgICAgICAgICAga2V5PWVuZHBvaW50X2lkLAogICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM9ewogICAgICAgICAgICAgICAgICAgICAgICAiY3VycmVudF9zdGF0cyI6IGpzb24uZHVtcHMoY3VycmVudF9zdGF0cyksCiAgICAgICAgICAgICAgICAgICAgICAgICJkcmlmdF9tZWFzdXJlcyI6IGpzb24uZHVtcHMoZHJpZnRfcmVzdWx0KSwKICAgICAgICAgICAgICAgICAgICAgICAgImRyaWZ0X3N0YXR1cyI6IGRyaWZ0X3N0YXR1cywKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIHRzZGJfZHJpZnRfbWVhc3VyZXMgPSB7CiAgICAgICAgICAgICAgICAgICAgImVuZHBvaW50X2lkIjogZW5kcG9pbnRfaWQsCiAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHBkLnRvX2RhdGV0aW1lKHRpbWVzdGFtcCwgZm9ybWF0PVRJTUVfRk9STUFUKSwKICAgICAgICAgICAgICAgICAgICAicmVjb3JkX3R5cGUiOiAiZHJpZnRfbWVhc3VyZXMiLAogICAgICAgICAgICAgICAgICAgICJ0dmRfbWVhbiI6IGRyaWZ0X3Jlc3VsdFsidHZkX21lYW4iXSwKICAgICAgICAgICAgICAgICAgICAia2xkX21lYW4iOiBkcmlmdF9yZXN1bHRbImtsZF9tZWFuIl0sCiAgICAgICAgICAgICAgICAgICAgImhlbGxpbmdlcl9tZWFuIjogZHJpZnRfcmVzdWx0WyJoZWxsaW5nZXJfbWVhbiJdLAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGYuZnJhbWVzLndyaXRlKAogICAgICAgICAgICAgICAgICAgIGJhY2tlbmQ9InRzZGIiLAogICAgICAgICAgICAgICAgICAgIHRhYmxlPXNlbGYudHNkYl9wYXRoLAogICAgICAgICAgICAgICAgICAgIGRmcz1wZC5EYXRhRnJhbWUuZnJvbV9kaWN0KFt0c2RiX2RyaWZ0X21lYXN1cmVzXSksCiAgICAgICAgICAgICAgICAgICAgaW5kZXhfY29scz1bInRpbWVzdGFtcCIsICJlbmRwb2ludF9pZCIsICJyZWNvcmRfdHlwZSJdLAogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiRG9uZSB1cGRhdGluZyBkcmlmdCBtZWFzdXJlcyB7ZnVsbF9wYXRofSIpCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSkKCiAgICBkZWYgY2hlY2tfZm9yX2RyaWZ0KHNlbGYsIGRyaWZ0X3Jlc3VsdCwgZW5kcG9pbnQpOgogICAgICAgIHR2ZF9tZWFuID0gZHJpZnRfcmVzdWx0LmdldCgidHZkX21lYW4iKQogICAgICAgIGhlbGxpbmdlcl9tZWFuID0gZHJpZnRfcmVzdWx0LmdldCgiaGVsbGluZ2VyX21lYW4iKQoKICAgICAgICBkcmlmdF9tZWFuID0gMC4wCiAgICAgICAgaWYgdHZkX21lYW4gYW5kIGhlbGxpbmdlcl9tZWFuOgogICAgICAgICAgICBkcmlmdF9tZWFuID0gKHR2ZF9tZWFuICsgaGVsbGluZ2VyX21lYW4pIC8gMgoKICAgICAgICBtb25pdG9yX2NvbmZpZ3VyYXRpb24gPSBlbmRwb2ludC5zcGVjLm1vbml0b3JfY29uZmlndXJhdGlvbiBvciB7fQoKICAgICAgICBwb3NzaWJsZV9kcmlmdCA9IG1vbml0b3JfY29uZmlndXJhdGlvbi5nZXQoCiAgICAgICAgICAgICJwb3NzaWJsZV9kcmlmdCIsIHNlbGYuZGVmYXVsdF9wb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQKICAgICAgICApCiAgICAgICAgZHJpZnRfZGV0ZWN0ZWQgPSBtb25pdG9yX2NvbmZpZ3VyYXRpb24uZ2V0KAogICAgICAgICAgICAicG9zc2libGVfZHJpZnQiLCBzZWxmLmRlZmF1bHRfZHJpZnRfZGV0ZWN0ZWRfdGhyZXNob2xkCiAgICAgICAgKQoKICAgICAgICBkcmlmdF9zdGF0dXMgPSAiTk9fRFJJRlQiCiAgICAgICAgaWYgZHJpZnRfbWVhbiA+PSBkcmlmdF9kZXRlY3RlZDoKICAgICAgICAgICAgZHJpZnRfc3RhdHVzID0gIkRSSUZUX0RFVEVDVEVEIgogICAgICAgIGVsaWYgZHJpZnRfbWVhbiA+PSBwb3NzaWJsZV9kcmlmdDoKICAgICAgICAgICAgZHJpZnRfc3RhdHVzID0gIlBPU1NJQkxFX0RSSUZUIgoKICAgICAgICByZXR1cm4gZHJpZnRfc3RhdHVzLCBkcmlmdF9tZWFuCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGdldF9sYXN0X2NyZWF0ZWRfZGlyKGZzLCBlbmRwb2ludF9kaXIpOgogICAgICAgIGRpcnMgPSBmcy5scyhlbmRwb2ludF9kaXJbIm5hbWUiXSkKICAgICAgICBsYXN0X2RpciA9IHNvcnRlZChkaXJzLCBrZXk9bGFtYmRhIGs6IGtbIm5hbWUiXS5zcGxpdCgiPSIpWy0xXSlbLTFdCiAgICAgICAgcmV0dXJuIGxhc3RfZGlyCgoKZGVmIGhhbmRsZXIoY29udGV4dDogTUxDbGllbnRDdHgpOgogICAgYmF0Y2hfcHJvY2Vzc29yID0gQmF0Y2hQcm9jZXNzb3IoCiAgICAgICAgY29udGV4dD1jb250ZXh0LAogICAgICAgIHByb2plY3Q9Y29udGV4dC5wcm9qZWN0LAogICAgICAgIG1vZGVsX21vbml0b3JpbmdfYWNjZXNzX2tleT1vcy5lbnZpcm9uLmdldCgiTU9ERUxfTU9OSVRPUklOR19BQ0NFU1NfS0VZIiksCiAgICAgICAgdjNpb19hY2Nlc3Nfa2V5PW9zLmVudmlyb24uZ2V0KCJWM0lPX0FDQ0VTU19LRVkiKSwKICAgICkKICAgIGJhdGNoX3Byb2Nlc3Nvci5wb3N0X2luaXQoKQogICAgYmF0Y2hfcHJvY2Vzc29yLnJ1bigpCg==
    commands: []
    code_origin: https://github.com/katyakats/functions.git#194040a50c6e2540c6408fdef0acfa41d0faf91e:/Users/katyak/work/functions/model_monitoring_batch/model_monitoring_batch.py
    origin_filename: /Users/katyak/work/functions/model_monitoring_batch/model_monitoring_batch.py
  disable_auto_mount: false
  priority_class_name: ''
  affinity: null
verbose: false
